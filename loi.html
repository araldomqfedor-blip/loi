<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Admin Panel - DAMAI AGRO FARM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #f8fafc;
            overflow-x: hidden;
        }
        
        .admin-sidebar {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 320px;
            overflow-y: auto;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .letter-preview {
            background: #f1f5f9;
            min-height: 100vh;
            padding: 20px;
            margin-left: 320px;
        }
        
        .letter-container {
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            min-height: 100vh;
            position: relative;
            max-width: 210mm;
            margin: 0 auto;
        }
        
        .editable {
            position: relative;
            transition: all 0.3s ease;
            border-radius: 4px;
            padding: 2px 4px;
        }
        
        .editable:hover {
            background: rgba(59, 130, 246, 0.1) !important;
            outline: 2px dashed #3b82f6 !important;
            cursor: pointer !important;
        }
        
        .editing {
            background: rgba(59, 130, 246, 0.2) !important;
            outline: 2px solid #3b82f6 !important;
        }
        
        .edit-popup {
            position: absolute;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            min-width: 300px;
        }
        
        .edit-popup textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
        
        .tab-button {
            background: #334155;
            border: none;
            color: #cbd5e1;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: #3b82f6;
            color: white;
        }
        
        .drag-handle {
            cursor: move;
            color: #64748b;
            padding: 5px;
        }
        
        .drag-handle:hover {
            color: #3b82f6;
        }
        
        .watermark {
            position: absolute;
            opacity: 0.03;
            font-size: 180px;
            font-weight: 900;
            color: #1e40af;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            pointer-events: none;
            z-index: 0;
        }
        
        .stamp {
            position: absolute;
            right: 60px;
            bottom: 60px;
            width: 120px;
            height: 120px;
            border: 2px dashed #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            color: #ef4444;
            transform: rotate(15deg);
            opacity: 0.7;
        }
        
        .toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 340px;
            z-index: 1001;
            background: #3b82f6;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }
        
        @media print {
            .admin-sidebar, .toggle-sidebar {
                display: none !important;
            }
            
            .letter-preview {
                margin-left: 0 !important;
                padding: 0 !important;
            }
            
            .letter-container {
                box-shadow: none !important;
                border: none !important;
            }
        }
        
        @media (max-width: 1024px) {
            .admin-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .admin-sidebar.open {
                transform: translateX(0);
            }
            
            .letter-preview {
                margin-left: 0;
            }
            
            .toggle-sidebar {
                left: 20px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Toggle Sidebar Button -->
    <div class="toggle-sidebar" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </div>
    
    <!-- Admin Sidebar -->
    <div class="admin-sidebar open">
        <div class="p-6">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-blue-500 p-3 rounded-lg">
                        <i class="fas fa-leaf text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">DAMAI AGRO FARM</h1>
                        <p class="text-blue-200 text-sm">Complete Admin Panel</p>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="saveChanges()" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-save"></i>
                        <span class="text-xs">Save</span>
                    </button>
                    <button onclick="updatePreview()" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-eye"></i>
                        <span class="text-xs">Preview</span>
                    </button>
                    <button onclick="downloadAsImage()" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-download"></i>
                        <span class="text-xs">JPG</span>
                    </button>
                    <button onclick="downloadAsPDF()" class="bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-file-pdf"></i>
                        <span class="text-xs">PDF</span>
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex mb-4 border-b border-gray-700">
                <button class="tab-button active" onclick="showTab('content')">Content</button>
                <button class="tab-button" onclick="showTab('style')">Style</button>
                <button class="tab-button" onclick="showTab('structure')">Structure</button>
                <button class="tab-button" onclick="showTab('advanced')">Advanced</button>
            </div>
            
            <!-- Content Tab -->
            <div id="content-tab" class="tab-content">
                <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Quick Edits -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3 flex items-center gap-2">
                            <i class="fas fa-bolt"></i> Quick Edits
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Document Title</label>
                                <input type="text" id="quick-title" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="LETTER OF INTENT">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Reference Number</label>
                                <input type="text" id="quick-ref" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="DAF-LOI-12/2023">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Date</label>
                                <input type="text" id="quick-date" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="December 05, 2023">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Company Details -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Company Details</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Company Name Line 1</label>
                                <input type="text" id="company-line1" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="DAMAI AGRO">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Company Name Line 2</label>
                                <input type="text" id="company-line2" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="FARM">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Tagline</label>
                                <input type="text" id="company-tagline" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="Agricultural Excellence Since 2005">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Phone Number</label>
                                <input type="text" id="company-phone" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="+62 857-6055-05611">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Email</label>
                                <input type="text" id="company-email" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="purchasedaf@yahoo.com">
                            </div>
                        </div>
                    </div>
                    
                    <!-- From/To Details -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Address Details</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">From Company</label>
                                <input type="text" id="from-company" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="Damai Agro Farm">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">To Company</label>
                                <input type="text" id="to-company" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="Silver Line Compass LLP">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">From Address Line 1</label>
                                <input type="text" id="from-address1" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="Jl. KKO. Thamrin No.12, RT.3/RW.14">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">From Address Line 2</label>
                                <input type="text" id="from-address2" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="Gondangdia, Kec. Daerah Khusus">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">From Address Line 3</label>
                                <input type="text" id="from-address3" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="Jakarta 12560, Indonesia">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Details -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Product Details</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Product Name</label>
                                <input type="text" id="product-name" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="Premium Grade Cardamom">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Quantity</label>
                                <input type="text" id="product-quantity" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="12 Metric Tons">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Value</label>
                                <input type="text" id="product-value" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="USD 385,000.00">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Signature Details -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Signature Details</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Signatory Name</label>
                                <input type="text" id="signatory-name" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="DAMAI KHAMUIR">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Designation</label>
                                <input type="text" id="signatory-designation" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1" value="Purchasing Manager">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button onclick="applyQuickEdits()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2">
                        <i class="fas fa-check"></i>
                        Apply All Quick Edits
                    </button>
                </div>
            </div>
            
            <!-- Style Tab -->
            <div id="style-tab" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Colors</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm text-gray-300">Primary Color</label>
                                <input type="color" id="color-primary" class="w-full h-10 cursor-pointer" value="#1e3a8a">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Secondary Color</label>
                                <input type="color" id="color-secondary" class="w-full h-10 cursor-pointer" value="#3b82f6">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Fonts</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Heading Font</label>
                                <select id="font-heading" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white">
                                    <option value="'Playfair Display', serif">Playfair Display</option>
                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Arial', sans-serif">Arial</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Body Font</label>
                                <select id="font-body" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white">
                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                    <option value="'Playfair Display', serif">Playfair Display</option>
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Arial', sans-serif">Arial</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Watermark</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Watermark Text</label>
                                <input type="text" id="watermark-text" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white" value="LETTER OF INTENT">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Watermark Opacity</label>
                                <input type="range" id="watermark-opacity" min="0" max="10" value="3" class="w-full">
                                <span id="opacity-value" class="text-xs text-gray-300">30%</span>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="applyStyles()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold">
                        Apply Styles
                    </button>
                </div>
            </div>
            
            <!-- Structure Tab -->
            <div id="structure-tab" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Sections</h4>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-header" checked class="mr-2">
                                <label for="section-header" class="text-gray-300">Header</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-address" checked class="mr-2">
                                <label for="section-address" class="text-gray-300">From/To Address</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-title" checked class="mr-2">
                                <label for="section-title" class="text-gray-300">Letter Title</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-content" checked class="mr-2">
                                <label for="section-content" class="text-gray-300">Main Content</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-table" checked class="mr-2">
                                <label for="section-table" class="text-gray-300">Product Table</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-signature" checked class="mr-2">
                                <label for="section-signature" class="text-gray-300">Signature</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-footer" checked class="mr-2">
                                <label for="section-footer" class="text-gray-300">Footer</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Reorder Sections</h4>
                        <p class="text-sm text-gray-400 mb-3">Drag and drop to reorder:</p>
                        <div id="sortable-sections" class="space-y-2">
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Header
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Address Section
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Letter Title
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Main Content
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Product Table
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Signature
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Footer
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="applyStructure()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold">
                        Apply Structure Changes
                    </button>
                </div>
            </div>
            
            <!-- Advanced Tab -->
            <div id="advanced-tab" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Table Editor</h4>
                        <div class="space-y-3">
                            <button onclick="addTableRow()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg">
                                <i class="fas fa-plus mr-2"></i> Add Table Row
                            </button>
                            <button onclick="removeTableRow()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg">
                                <i class="fas fa-minus mr-2"></i> Remove Last Row
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Export/Import</h4>
                        <div class="space-y-3">
                            <button onclick="exportData()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg">
                                <i class="fas fa-file-export mr-2"></i> Export Data
                            </button>
                            <button onclick="importData()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded-lg">
                                <i class="fas fa-file-import mr-2"></i> Import Data
                            </button>
                            <input type="file" id="import-file" class="hidden" accept=".json">
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Reset Options</h4>
                        <div class="space-y-2">
                            <button onclick="resetToDefault()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg">
                                <i class="fas fa-undo mr-2"></i> Reset All Content
                            </button>
                            <button onclick="clearAll()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg">
                                <i class="fas fa-trash mr-2"></i> Clear Everything
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status -->
            <div class="mt-6 p-4 bg-gray-800/50 rounded-lg">
                <h4 class="font-bold text-blue-300 mb-2">Status</h4>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-300">Last Saved:</span>
                        <span id="last-saved" class="text-white">Not saved yet</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Word Count:</span>
                        <span id="word-count" class="text-white">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Editing Mode:</span>
                        <span id="edit-mode" class="text-green-400">ON</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preview Area -->
    <div class="letter-preview">
        <div id="letter-container" class="letter-container p-8 md:p-12">
            <!-- This entire area is editable -->
            <!-- We'll build it dynamically -->
        </div>
        
        <!-- Edit Popup -->
        <div id="edit-popup" class="edit-popup hidden">
            <div class="mb-3">
                <h4 class="font-bold text-gray-800">Edit Content</h4>
                <p class="text-sm text-gray-600" id="edit-label"></p>
            </div>
            <textarea id="edit-textarea" placeholder="Enter content here..."></textarea>
            <div class="flex gap-2 mt-3">
                <button onclick="saveEdit()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex-1">
                    Save
                </button>
                <button onclick="cancelEdit()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentEditingElement = null;
        let changesMade = 0;
        let isEditingMode = true;
        let letterData = {};
        
        // Default data structure
        const defaultData = {
            header: {
                companyLine1: "DAMAI AGRO",
                companyLine2: "FARM",
                tagline: "Agricultural Excellence Since 2005",
                phone: "+62 857-6055-05611",
                email: "purchasedaf@yahoo.com",
                documentType: "Letter of Intent",
                date: "December 05, 2023",
                reference: "Ref: DAF-LOI-12/2023"
            },
            addresses: {
                fromCompany: "Damai Agro Farm",
                fromAddress1: "Jl. KKO. Thamrin No.12, RT.3/RW.14",
                fromAddress2: "Gondangdia, Kec. Daerah Khusus",
                fromAddress3: "Jakarta 12560, Indonesia",
                toCompany: "Silver Line Compass LLP",
                toAddress1: "H.NO-1804/5 Barchi Road Dandeli",
                toAddress2: "Uttara Kannada Karnataka",
                toAddress3: "581325, India"
            },
            content: {
                title: "LETTER OF INTENT",
                salutation: "Dear Sir/Madam,",
                paragraph1: "We take this opportunity to formally declare our intention to procure agricultural products from your esteemed company. <strong>Damai Agro Farm</strong> is a duly registered entity operating under the laws of the Republic of Indonesia, with our principal business located at:",
                addressQuote: "Jl. KKO. Thamrin No.12, RT.3/RW.14, Gondangdia, Kec. Daerah Khusus Jakarta, Indonesia",
                paragraph2: "Our core business activities encompass comprehensive agricultural services and high-quality produce distribution across Southeast Asia.",
                paragraph3: "In accordance with our business expansion strategy, we hereby confirm with full corporate responsibility our willingness and capacity to enter into a formal purchase agreement for the following commodities:",
                tableRows: [
                    ["Product Name", "Premium Grade Cardamom"],
                    ["Total Quantity", "12 Metric Tons"],
                    ["Total Contract Value", "USD 385,000.00"],
                    ["Delivery Schedule", "Within 35 days from Purchase Order date<br><span class='text-sm text-gray-600'>(Can be delivered in multiple shipments)</span>"],
                    ["Documentation Requirements", "• Certificate of Origin<br>• Quality Inspection Certificate<br>• Phytosanitary Certificate<br>• All necessary export/import permits"]
                ],
                shippingTerms: {
                    origin: "JNPT, Navi Mumbai, India",
                    destination: "Tanjung Priok, Jakarta, Indonesia",
                    incoterms: "FOB (JNPT, India)"
                },
                paymentTerms: {
                    advance: "60% upon signing contract",
                    balance: "40% against Letter of Credit",
                    lcType: "Irrevocable, Confirmed"
                },
                closing1: "We acknowledge that this Letter of Intent serves as a preliminary framework for further negotiations and does not constitute a binding agreement until a formal contract is executed by both parties.",
                closing2: "We eagerly anticipate a mutually beneficial business relationship and look forward to your positive response."
            },
            signature: {
                name: "DAMAI KHAMUIR",
                designation: "Purchasing Manager",
                company: "DAMAI AGRO FARM",
                date: "December 05, 2023"
            },
            styles: {
                primaryColor: "#1e3a8a",
                secondaryColor: "#3b82f6",
                headingFont: "'Playfair Display', serif",
                bodyFont: "'Montserrat', sans-serif",
                watermarkText: "LETTER OF INTENT",
                watermarkOpacity: 0.03
            }
        };
        
        // Initialize
        function init() {
            // Load data from localStorage or use default
            const savedData = localStorage.getItem('damaiAgroLetter');
            if (savedData) {
                letterData = JSON.parse(savedData);
            } else {
                letterData = JSON.parse(JSON.stringify(defaultData));
            }
            
            // Initialize form inputs
            initializeFormInputs();
            
            // Render the letter
            renderLetter();
            
            // Initialize sortable
            Sortable.create(document.getElementById('sortable-sections'), {
                animation: 150,
                ghostClass: 'bg-blue-900/20'
            });
            
            // Calculate word count
            calculateWordCount();
            
            // Update status
            updateStatus();
        }
        
        // Initialize form inputs with current data
        function initializeFormInputs() {
            // Quick Edits
            document.getElementById('quick-title').value = letterData.content.title;
            document.getElementById('quick-ref').value = letterData.header.reference.replace("Ref: ", "");
            document.getElementById('quick-date').value = letterData.header.date;
            
            // Company Details
            document.getElementById('company-line1').value = letterData.header.companyLine1;
            document.getElementById('company-line2').value = letterData.header.companyLine2;
            document.getElementById('company-tagline').value = letterData.header.tagline;
            document.getElementById('company-phone').value = letterData.header.phone;
            document.getElementById('company-email').value = letterData.header.email;
            
            // Address Details
            document.getElementById('from-company').value = letterData.addresses.fromCompany;
            document.getElementById('to-company').value = letterData.addresses.toCompany;
            document.getElementById('from-address1').value = letterData.addresses.fromAddress1;
            document.getElementById('from-address2').value = letterData.addresses.fromAddress2;
            document.getElementById('from-address3').value = letterData.addresses.fromAddress3;
            
            // Product Details
            document.getElementById('product-name').value = letterData.content.tableRows[0][1];
            document.getElementById('product-quantity').value = letterData.content.tableRows[1][1];
            document.getElementById('product-value').value = letterData.content.tableRows[2][1];
            
            // Signature Details
            document.getElementById('signatory-name').value = letterData.signature.name;
            document.getElementById('signatory-designation').value = letterData.signature.designation;
            
            // Style inputs
            document.getElementById('color-primary').value = letterData.styles.primaryColor;
            document.getElementById('color-secondary').value = letterData.styles.secondaryColor;
            document.getElementById('font-heading').value = letterData.styles.headingFont;
            document.getElementById('font-body').value = letterData.styles.bodyFont;
            document.getElementById('watermark-text').value = letterData.styles.watermarkText;
            document.getElementById('watermark-opacity').value = Math.round(letterData.styles.watermarkOpacity * 100 / 10);
            document.getElementById('opacity-value').textContent = Math.round(letterData.styles.watermarkOpacity * 100) + "%";
        }
        
        // Render the letter
        function renderLetter() {
            const container = document.getElementById('letter-container');
            container.innerHTML = '';
            
            // Create sections array
            const sections = [
                { id: 'header', render: renderHeader },
                { id: 'addresses', render: renderAddresses },
                { id: 'title', render: renderTitle },
                { id: 'content', render: renderContent },
                { id: 'table', render: renderTable },
                { id: 'signature', render: renderSignature },
                { id: 'footer', render: renderFooter }
            ];
            
            // Add watermark
            const watermark = document.createElement('div');
            watermark.className = 'watermark';
            watermark.textContent = letterData.styles.watermarkText;
            watermark.style.opacity = letterData.styles.watermarkOpacity;
            container.appendChild(watermark);
            
            // Render each section
            sections.forEach(section => {
                const sectionElement = section.render();
                if (sectionElement) {
                    container.appendChild(sectionElement);
                }
            });
            
            // Add stamp
            const stamp = document.createElement('div');
            stamp.className = 'stamp';
            stamp.innerHTML = `
                <div class="text-center">
                    <div class="text-xs mb-1">OFFICIAL</div>
                    <div class="font-bold">DAMAI AGRO</div>
                    <div class="text-xs mt-1">FARM</div>
                </div>
            `;
            container.appendChild(stamp);
            
            // Apply styles
            applyStylesToLetter();
            
            // Make elements editable
            makeElementsEditable();
        }
        
        // Render header section
        function renderHeader() {
            const section = document.createElement('div');
            section.className = 'mb-12';
            section.innerHTML = `
                <div class="bg-gradient-to-r from-blue-900 to-blue-700 text-white rounded-xl shadow-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="flex items-center gap-4 mb-6 md:mb-0">
                            <div class="bg-blue-500 w-16 h-16 flex items-center justify-center shadow-lg rounded-lg">
                                <i class="fas fa-leaf text-2xl text-white"></i>
                            </div>
                            <div>
                                <h1 class="text-3xl md:text-4xl font-bold" data-edit="header.companyLine1">${letterData.header.companyLine1}</h1>
                                <h2 class="text-3xl md:text-4xl font-bold" data-edit="header.companyLine2">${letterData.header.companyLine2}</h2>
                                <p class="text-blue-200 text-sm mt-1" data-edit="header.tagline">${letterData.header.tagline}</p>
                            </div>
                        </div>
                        
                        <div class="text-center md:text-right">
                            <div class="mb-2">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                <span>Gondangdia, Jakarta 10350</span>
                            </div>
                            <div class="mb-2">
                                <i class="fas fa-phone mr-2"></i>
                                <span data-edit="header.phone">${letterData.header.phone}</span>
                            </div>
                            <div>
                                <i class="fas fa-envelope mr-2"></i>
                                <span class="text-blue-200" data-edit="header.email">${letterData.header.email}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-blue-400">
                        <div class="flex flex-wrap justify-between items-center">
                            <div>
                                <p class="text-blue-200"><i class="fas fa-file-contract mr-2"></i> <span data-edit="header.documentType">${letterData.header.documentType}</span></p>
                            </div>
                            <div class="flex gap-4">
                                <p class="text-blue-200"><i class="far fa-calendar mr-2"></i> <span data-edit="header.date">${letterData.header.date}</span></p>
                                <p class="text-blue-200"><i class="fas fa-hashtag mr-2"></i> <span data-edit="header.reference">${letterData.header.reference}</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return section;
        }
        
        // Render addresses section
        function renderAddresses() {
            const section = document.createElement('div');
            section.className = 'grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12';
            section.innerHTML = `
                <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-blue-100 p-2 rounded-full">
                            <i class="fas fa-building text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">From: <span data-edit="addresses.fromCompany">${letterData.addresses.fromCompany}</span></h3>
                    </div>
                    <div class="space-y-2 text-gray-700">
                        <p><strong>Address:</strong></p>
                        <p data-edit="addresses.fromAddress1">${letterData.addresses.fromAddress1}</p>
                        <p data-edit="addresses.fromAddress2">${letterData.addresses.fromAddress2}</p>
                        <p data-edit="addresses.fromAddress3">${letterData.addresses.fromAddress3}</p>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-blue-100 p-2 rounded-full">
                            <i class="fas fa-users text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">To: <span data-edit="addresses.toCompany">${letterData.addresses.toCompany}</span></h3>
                    </div>
                    <div class="space-y-2 text-gray-700">
                        <p><strong>Address:</strong></p>
                        <p data-edit="addresses.toAddress1">${letterData.addresses.toAddress1}</p>
                        <p data-edit="addresses.toAddress2">${letterData.addresses.toAddress2}</p>
                        <p data-edit="addresses.toAddress3">${letterData.addresses.toAddress3}</p>
                    </div>
                </div>
            `;
            return section;
        }
        
        // Render title section
        function renderTitle() {
            const section = document.createElement('div');
            section.className = 'text-center mb-12';
            section.innerHTML = `
                <h1 class="text-4xl md:text-5xl font-bold mb-4" data-edit="content.title" style="font-family: ${letterData.styles.headingFont}; color: ${letterData.styles.primaryColor}">${letterData.content.title}</h1>
                <div class="h-1 w-32 bg-blue-600 mx-auto rounded-full"></div>
            `;
            return section;
        }
        
        // Render main content
        function renderContent() {
            const section = document.createElement('div');
            section.className = 'space-y-6 text-gray-800 text-justify mb-8';
            section.innerHTML = `
                <p>
                    <span class="font-semibold text-lg" data-edit="content.salutation">${letterData.content.salutation}</span>
                </p>

                <p data-edit="content.paragraph1">${letterData.content.paragraph1}</p>

                <div class="bg-blue-50 p-5 rounded-lg my-6 border-l-4 border-blue-500">
                    <p class="font-medium text-blue-800 italic" data-edit="content.addressQuote">
                        "${letterData.content.addressQuote}"
                    </p>
                </div>

                <p data-edit="content.paragraph2">${letterData.content.paragraph2}</p>

                <p class="font-medium" style="color: ${letterData.styles.primaryColor}" data-edit="content.paragraph3">
                    ${letterData.content.paragraph3}
                </p>
            `;
            return section;
        }
        
        // Render table
        function renderTable() {
            const section = document.createElement('div');
            section.className = 'overflow-x-auto my-8';
            
            let tableRowsHTML = '';
            letterData.content.tableRows.forEach((row, index) => {
                tableRowsHTML += `
                    <tr class="${index % 2 === 0 ? 'hover:bg-gray-50' : 'hover:bg-gray-50 bg-gray-50'}">
                        <td class="border border-gray-300 px-6 py-4 font-semibold" data-edit="content.tableRows.${index}.0" data-index="${index}" data-col="0">${row[0]}</td>
                        <td class="border border-gray-300 px-6 py-4" data-edit="content.tableRows.${index}.1" data-index="${index}" data-col="1">${row[1]}</td>
                    </tr>
                `;
            });
            
            section.innerHTML = `
                <table class="w-full border-collapse border border-gray-300 shadow-sm">
                    <thead class="bg-gradient-to-r from-blue-50 to-blue-100">
                        <tr>
                            <th class="border border-gray-300 px-6 py-4 text-left font-bold text-gray-800">Description</th>
                            <th class="border border-gray-300 px-6 py-4 text-left font-bold text-gray-800">Specifications</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRowsHTML}
                    </tbody>
                </table>
            `;
            return section;
        }
        
        // Render shipping and payment terms
        function renderTerms() {
            const section = document.createElement('div');
            section.className = 'grid grid-cols-1 md:grid-cols-2 gap-6 my-8';
            section.innerHTML = `
                <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                    <h4 class="font-bold text-green-800 mb-4 text-lg flex items-center gap-2">
                        <i class="fas fa-ship"></i> Shipping Terms
                    </h4>
                    <div class="space-y-2">
                        <p><strong class="text-green-700">Origin Port:</strong> <span data-edit="content.shippingTerms.origin">${letterData.content.shippingTerms.origin}</span></p>
                        <p><strong class="text-green-700">Destination Port:</strong> <span data-edit="content.shippingTerms.destination">${letterData.content.shippingTerms.destination}</span></p>
                        <p><strong class="text-green-700">Incoterms:</strong> <span data-edit="content.shippingTerms.incoterms">${letterData.content.shippingTerms.incoterms}</span></p>
                    </div>
                </div>
                
                <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                    <h4 class="font-bold text-yellow-800 mb-4 text-lg flex items-center gap-2">
                        <i class="fas fa-file-invoice-dollar"></i> Payment Terms
                    </h4>
                    <div class="space-y-2">
                        <p><strong class="text-yellow-700">Advance Payment:</strong> <span data-edit="content.paymentTerms.advance">${letterData.content.paymentTerms.advance}</span></p>
                        <p><strong class="text-yellow-700">Balance Payment:</strong> <span data-edit="content.paymentTerms.balance">${letterData.content.paymentTerms.balance}</span></p>
                        <p><strong class="text-yellow-700">L/C Type:</strong> <span data-edit="content.paymentTerms.lcType">${letterData.content.paymentTerms.lcType}</span></p>
                    </div>
                </div>
            `;
            return section;
        }
        
        // Render closing paragraphs
        function renderClosing() {
            const section = document.createElement('div');
            section.innerHTML = `
                <p class="italic text-gray-700 mt-8" data-edit="content.closing1">
                    ${letterData.content.closing1}
                </p>

                <p class="font-medium mt-6" data-edit="content.closing2">
                    ${letterData.content.closing2}
                </p>
            `;
            return section;
        }
        
        // Render signature
        function renderSignature() {
            const section = document.createElement('div');
            section.className = 'mt-16 pt-8 border-t border-gray-300';
            section.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-start">
                    <div class="mb-8 md:mb-0">
                        <p class="text-lg font-medium text-gray-700 mb-6">Sincerely,</p>
                        
                        <div class="space-y-1">
                            <p class="text-2xl font-bold text-gray-900" data-edit="signature.name">${letterData.signature.name}</p>
                            <p class="text-gray-600" data-edit="signature.designation">${letterData.signature.designation}</p>
                            <p class="text-blue-700 font-medium" data-edit="signature.company">${letterData.signature.company}</p>
                        </div>
                        
                        <div class="border-b-2 border-gray-800 w-64 mt-8"></div>
                        <p class="text-sm text-gray-500 mt-2">Authorized Signature</p>
                    </div>
                    
                    <div class="text-right">
                        <div class="bg-gray-50 p-5 rounded-lg inline-block">
                            <p class="font-bold text-gray-800 mb-2">Date of Issue:</p>
                            <p class="text-lg text-blue-700" data-edit="signature.date">${letterData.signature.date}</p>
                        </div>
                    </div>
                </div>
            `;
            return section;
        }
        
        // Render footer
        function renderFooter() {
            const section = document.createElement('footer');
            section.className = 'bg-gray-900 text-white py-8 mt-12 rounded-xl';
            section.innerHTML = `
                <div class="max-w-6xl mx-auto px-4">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="mb-6 md:mb-0">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-blue-600 p-2 rounded-lg">
                                    <i class="fas fa-leaf"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold">DAMAI AGRO FARM</h3>
                                    <p class="text-gray-400 text-sm">Quality Agricultural Products</p>
                                </div>
                            </div>
                            <p class="text-gray-400 text-sm">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                Gondangdia, Jakarta 10350, Indonesia
                            </p>
                        </div>
                        
                        <div class="text-center md:text-right">
                            <div class="flex gap-6 mb-4">
                                <span class="text-blue-300">
                                    <i class="fas fa-phone mr-2"></i>${letterData.header.phone}
                                </span>
                                <span class="text-blue-300">
                                    <i class="fas fa-envelope mr-2"></i>${letterData.header.email}
                                </span>
                            </div>
                            <p class="text-gray-400 text-sm">
                                © 2023 Damai Agro Farm. All Rights Reserved.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return section;
        }
        
        // Make elements editable
        function makeElementsEditable() {
            const editableElements = document.querySelectorAll('[data-edit]');
            
            editableElements.forEach(element => {
                // Add editable class
                element.classList.add('editable');
                
                // Add click event
                element.addEventListener('click', function(e) {
                    if (!isEditingMode) return;
                    
                    e.stopPropagation();
                    startEditing(this);
                });
            });
            
            // Add table cell editing
            const tableCells = document.querySelectorAll('td[data-edit]');
            tableCells.forEach(cell => {
                cell.addEventListener('click', function(e) {
                    if (!isEditingMode) return;
                    
                    e.stopPropagation();
                    startEditing(this);
                });
            });
        }
        
        // Start editing an element
        function startEditing(element) {
            if (currentEditingElement) {
                currentEditingElement.classList.remove('editing');
            }
            
            currentEditingElement = element;
            currentEditingElement.classList.add('editing');
            
            const editPath = element.getAttribute('data-edit');
            const popup = document.getElementById('edit-popup');
            const textarea = document.getElementById('edit-textarea');
            const label = document.getElementById('edit-label');
            
            // Get current value based on edit path
            let currentValue = getValueByPath(letterData, editPath);
            
            // For table cells, get the specific value
            if (editPath.startsWith('content.tableRows')) {
                const index = element.getAttribute('data-index');
                const col = element.getAttribute('data-col');
                currentValue = letterData.content.tableRows[index][col];
            }
            
            // Set label and value
            label.textContent = `Editing: ${editPath}`;
            textarea.value = currentValue;
            
            // Position popup near the element
            const rect = element.getBoundingClientRect();
            popup.style.top = `${rect.top + window.scrollY}px`;
            popup.style.left = `${rect.left + window.scrollX}px`;
            popup.classList.remove('hidden');
            
            // Focus textarea
            textarea.focus();
        }
        
        // Save edit
        function saveEdit() {
            if (!currentEditingElement) return;
            
            const editPath = currentEditingElement.getAttribute('data-edit');
            const newValue = document.getElementById('edit-textarea').value;
            
            // Update data based on edit path
            if (editPath.startsWith('content.tableRows')) {
                const index = currentEditingElement.getAttribute('data-index');
                const col = currentEditingElement.getAttribute('data-col');
                letterData.content.tableRows[index][col] = newValue;
            } else {
                setValueByPath(letterData, editPath, newValue);
            }
            
            // Update the element
            currentEditingElement.innerHTML = newValue;
            
            // Close popup
            cancelEdit();
            
            // Increment changes
            changesMade++;
            updateStatus();
            
            // Update word count
            calculateWordCount();
        }
        
        // Cancel edit
        function cancelEdit() {
            if (currentEditingElement) {
                currentEditingElement.classList.remove('editing');
                currentEditingElement = null;
            }
            
            document.getElementById('edit-popup').classList.add('hidden');
        }
        
        // Get value by path
        function getValueByPath(obj, path) {
            return path.split('.').reduce((o, p) => o[p], obj);
        }
        
        // Set value by path
        function setValueByPath(obj, path, value) {
            const keys = path.split('.');
            const lastKey = keys.pop();
            const target = keys.reduce((o, p) => o[p], obj);
            target[lastKey] = value;
        }
        
        // Apply quick edits from form
        function applyQuickEdits() {
            // Update data from form inputs
            letterData.content.title = document.getElementById('quick-title').value;
            letterData.header.reference = `Ref: ${document.getElementById('quick-ref').value}`;
            letterData.header.date = document.getElementById('quick-date').value;
            
            letterData.header.companyLine1 = document.getElementById('company-line1').value;
            letterData.header.companyLine2 = document.getElementById('company-line2').value;
            letterData.header.tagline = document.getElementById('company-tagline').value;
            letterData.header.phone = document.getElementById('company-phone').value;
            letterData.header.email = document.getElementById('company-email').value;
            
            letterData.addresses.fromCompany = document.getElementById('from-company').value;
            letterData.addresses.toCompany = document.getElementById('to-company').value;
            letterData.addresses.fromAddress1 = document.getElementById('from-address1').value;
            letterData.addresses.fromAddress2 = document.getElementById('from-address2').value;
            letterData.addresses.fromAddress3 = document.getElementById('from-address3').value;
            
            letterData.content.tableRows[0][1] = document.getElementById('product-name').value;
            letterData.content.tableRows[1][1] = document.getElementById('product-quantity').value;
            letterData.content.tableRows[2][1] = document.getElementById('product-value').value;
            
            letterData.signature.name = document.getElementById('signatory-name').value;
            letterData.signature.designation = document.getElementById('signatory-designation').value;
            
            // Re-render letter
            renderLetter();
            
            // Show notification
            showNotification('Quick edits applied successfully!', 'success');
            changesMade++;
            updateStatus();
        }
        
        // Apply styles
        function applyStyles() {
            letterData.styles.primaryColor = document.getElementById('color-primary').value;
            letterData.styles.secondaryColor = document.getElementById('color-secondary').value;
            letterData.styles.headingFont = document.getElementById('font-heading').value;
            letterData.styles.bodyFont = document.getElementById('font-body').value;
            letterData.styles.watermarkText = document.getElementById('watermark-text').value;
            letterData.styles.watermarkOpacity = document.getElementById('watermark-opacity').value / 100;
            
            // Update opacity display
            document.getElementById('opacity-value').textContent = 
                Math.round(letterData.styles.watermarkOpacity * 100) + "%";
            
            // Apply styles to letter
            applyStylesToLetter();
            
            // Update watermark
            const watermark = document.querySelector('.watermark');
            if (watermark) {
                watermark.textContent = letterData.styles.watermarkText;
                watermark.style.opacity = letterData.styles.watermarkOpacity;
            }
            
            showNotification('Styles applied successfully!', 'success');
            changesMade++;
            updateStatus();
        }
        
        // Apply styles to letter
        function applyStylesToLetter() {
            // Update CSS variables or inline styles
            const container = document.getElementById('letter-container');
            
            // Update heading font
            const headings = container.querySelectorAll('[class*="text-4xl"], [class*="text-5xl"], [class*="text-3xl"]');
            headings.forEach(h => {
                h.style.fontFamily = letterData.styles.headingFont;
            });
            
            // Update primary color elements
            const primaryColorElements = container.querySelectorAll('.text-blue-900, .from-blue-900');
            primaryColorElements.forEach(el => {
                if (el.classList.contains('text-blue-900')) {
                    el.style.color = letterData.styles.primaryColor;
                }
                if (el.classList.contains('from-blue-900')) {
                    el.style.background = `linear-gradient(to right, ${letterData.styles.primaryColor}, ${letterData.styles.secondaryColor})`;
                }
            });
        }
        
        // Apply structure changes
        function applyStructure() {
            showNotification('Structure changes applied!', 'info');
            // Note: Full structure reordering would require more complex implementation
        }
        
        // Add table row
        function addTableRow() {
            letterData.content.tableRows.push(["New Description", "New Value"]);
            renderLetter();
            showNotification('Table row added!', 'success');
            changesMade++;
            updateStatus();
        }
        
        // Remove table row
        function removeTableRow() {
            if (letterData.content.tableRows.length > 1) {
                letterData.content.tableRows.pop();
                renderLetter();
                showNotification('Last table row removed!', 'success');
                changesMade++;
                updateStatus();
            } else {
                showNotification('Cannot remove the last row!', 'error');
            }
        }
        
        // Export data
        function exportData() {
            const dataStr = JSON.stringify(letterData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `damai-agro-letter-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Data exported successfully!', 'success');
        }
        
        // Import data
        function importData() {
            document.getElementById('import-file').click();
        }
        
        // Handle file import
        document.getElementById('import-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    letterData = importedData;
                    initializeFormInputs();
                    renderLetter();
                    showNotification('Data imported successfully!', 'success');
                    changesMade = 0;
                    updateStatus();
                } catch (error) {
                    showNotification('Error importing file!', 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            e.target.value = '';
        });
        
        // Reset to default
        function resetToDefault() {
            if (confirm('Are you sure you want to reset to default values? All changes will be lost.')) {
                letterData = JSON.parse(JSON.stringify(defaultData));
                initializeFormInputs();
                renderLetter();
                showNotification('Reset to default values!', 'info');
                changesMade = 0;
                updateStatus();
            }
        }
        
        // Clear all
        function clearAll() {
            if (confirm('Are you sure you want to clear everything? This cannot be undone.')) {
                letterData = {
                    header: { companyLine1: "", companyLine2: "", tagline: "", phone: "", email: "", documentType: "", date: "", reference: "" },
                    addresses: { fromCompany: "", fromAddress1: "", fromAddress2: "", fromAddress3: "", toCompany: "", toAddress1: "", toAddress2: "", toAddress3: "" },
                    content: { title: "", salutation: "", paragraph1: "", addressQuote: "", paragraph2: "", paragraph3: "", tableRows: [["", ""]], shippingTerms: { origin: "", destination: "", incoterms: "" }, paymentTerms: { advance: "", balance: "", lcType: "" }, closing1: "", closing2: "" },
                    signature: { name: "", designation: "", company: "", date: "" },
                    styles: letterData.styles
                };
                initializeFormInputs();
                renderLetter();
                showNotification('All content cleared!', 'warning');
                changesMade = 0;
                updateStatus();
            }
        }
        
        // Save changes
        function saveChanges() {
            localStorage.setItem('damaiAgroLetter', JSON.stringify(letterData));
            const now = new Date();
            document.getElementById('last-saved').textContent = 
                `${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            showNotification('Changes saved successfully!', 'success');
            changesMade = 0;
            updateStatus();
        }
        
        // Update preview
        function updatePreview() {
            renderLetter();
            showNotification('Preview updated!', 'info');
        }
        
        // Download as image
        function downloadAsImage() {
            const element = document.getElementById('letter-container');
            
            showNotification('Generating image...', 'info');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                backgroundColor: "#ffffff",
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `damai-agro-letter-${new Date().toISOString().slice(0,10)}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                
                showNotification('Image downloaded successfully!', 'success');
            }).catch(error => {
                console.error('Error generating image:', error);
                showNotification('Error generating image!', 'error');
            });
        }
        
        // Download as PDF (simulated)
        function downloadAsPDF() {
            showNotification('PDF download would require additional libraries like jsPDF', 'info');
            // For actual PDF generation, you would need jsPDF library
        }
        
        // Calculate word count
        function calculateWordCount() {
            const text = document.getElementById('letter-container').innerText;
            const words = text.trim().split(/\s+/).filter(word => word.length > 0);
            document.getElementById('word-count').textContent = words.length;
        }
        
        // Update status
        function updateStatus() {
            document.getElementById('last-saved').textContent = 
                localStorage.getItem('damaiAgroLetter') ? 'Saved' : 'Not saved yet';
        }
        
        // Show tab
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show selected tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        }
        
        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.admin-sidebar');
            sidebar.classList.toggle('open');
        }
        
        // Show notification
        function showNotification(message, type) {
            // Remove existing notification
            const existing = document.querySelector('.notification-toast');
            if (existing) existing.remove();
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification-toast fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                type === 'warning' ? 'bg-yellow-600' : 
                'bg-blue-600'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 
                        'fa-info-circle'
                    }"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Close edit popup when clicking outside
        document.addEventListener('click', function(e) {
            const popup = document.getElementById('edit-popup');
            if (!popup.contains(e.target) && currentEditingElement !== e.target) {
                cancelEdit();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveChanges();
            }
            
            // Ctrl+E to toggle edit mode
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                isEditingMode = !isEditingMode;
                document.getElementById('edit-mode').textContent = isEditingMode ? 'ON' : 'OFF';
                document.getElementById('edit-mode').className = 
                    isEditingMode ? 'text-green-400' : 'text-red-400';
                showNotification(`Edit mode ${isEditingMode ? 'enabled' : 'disabled'}`, 'info');
            }
            
            // Escape to cancel edit
            if (e.key === 'Escape') {
                cancelEdit();
            }
            
            // Ctrl+D to download image
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                downloadAsImage();
            }
            
            // Ctrl+P to update preview
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                updatePreview();
            }
        });
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>