<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Admin Panel - Opulence Group Indonesia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #f8fafc;
            overflow-x: hidden;
        }
        
        .admin-sidebar {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 320px;
            overflow-y: auto;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .letter-preview {
            background: #f1f5f9;
            min-height: 100vh;
            padding: 20px;
            margin-left: 320px;
        }
        
        .letter-container {
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            min-height: 100vh;
            position: relative;
            max-width: 210mm;
            margin: 0 auto;
        }
        
        .editable {
            position: relative;
            transition: all 0.3s ease;
            border-radius: 4px;
            padding: 2px 4px;
            min-height: 20px;
        }
        
        .editable:hover {
            background: rgba(59, 130, 246, 0.1) !important;
            outline: 2px dashed #3b82f6 !important;
            cursor: text !important;
        }
        
        .editing {
            background: rgba(59, 130, 246, 0.2) !important;
            outline: 2px solid #3b82f6 !important;
        }
        
        .edit-popup {
            position: fixed;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            min-width: 400px;
            max-width: 500px;
        }
        
        .edit-popup textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            line-height: 1.5;
        }
        
        .edit-popup textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .tab-button {
            background: #334155;
            border: none;
            color: #cbd5e1;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .tab-button.active {
            background: #3b82f6;
            color: white;
        }
        
        .drag-handle {
            cursor: move;
            color: #64748b;
            padding: 5px;
        }
        
        .drag-handle:hover {
            color: #3b82f6;
        }
        
        .toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 340px;
            z-index: 1001;
            background: #3b82f6;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        
        .toggle-sidebar:hover {
            transform: scale(1.1);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
            background: white;
            padding: 5px;
        }
        
        .product-item {
            background: #374151;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        /* Floating Edit Toolbar */
        .floating-toolbar {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            padding: 8px;
            z-index: 9999;
            display: flex;
            gap: 5px;
            align-items: center;
            border: 1px solid #e5e7eb;
        }
        
        .floating-toolbar button {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 4px;
            background: #f8fafc;
            color: #475569;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .floating-toolbar button:hover {
            background: #e2e8f0;
            color: #1e293b;
        }
        
        .floating-toolbar button.active {
            background: #3b82f6;
            color: white;
        }
        
        @media print {
            .admin-sidebar, .toggle-sidebar, .floating-toolbar {
                display: none !important;
            }
            
            .letter-preview {
                margin-left: 0 !important;
                padding: 0 !important;
            }
            
            .letter-container {
                box-shadow: none !important;
                border: none !important;
            }
        }
        
        @media (max-width: 1024px) {
            .admin-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .admin-sidebar.open {
                transform: translateX(0);
            }
            
            .letter-preview {
                margin-left: 0;
            }
            
            .toggle-sidebar {
                left: 20px;
            }
            
            .edit-popup {
                min-width: 300px;
                max-width: 90vw;
                left: 50% !important;
                transform: translateX(-50%);
            }
        }
        
        /* Font Editor Styles */
        .font-editor {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            z-index: 10001;
            width: 300px;
            border: 1px solid #e5e7eb;
        }
        
        .font-editor select,
        .font-editor input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .font-editor select:focus,
        .font-editor input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid #e5e7eb;
        }
        
        /* Table specific styles */
        .table-editable {
            position: relative;
        }
        
        .table-editable:hover {
            background: rgba(59, 130, 246, 0.1) !important;
            outline: 2px dashed #3b82f6 !important;
        }
        
        .table-editing {
            background: rgba(59, 130, 246, 0.2) !important;
            outline: 2px solid #3b82f6 !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Toggle Sidebar Button -->
    <div class="toggle-sidebar" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </div>
    
    <!-- Admin Sidebar -->
    <div class="admin-sidebar open">
        <div class="p-6">
            <!-- Header -->
            <div class="mb-8">
                <div class="logo-container mb-4">
                    <img src="https://araldomqfedor-blip.github.io/loi/loko.png" alt="Opulence Group Indonesia Logo" class="logo-image">
                    <div>
                        <h1 class="text-2xl font-bold">OPULENCE GROUP INDONESIA</h1>
                        <p class="text-blue-200 text-sm">Complete Admin Panel</p>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="saveChanges()" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg flex flex-col items-center justify-center gap-1 transition-colors">
                        <i class="fas fa-save"></i>
                        <span class="text-xs">Save</span>
                    </button>
                    <button onclick="updatePreview()" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg flex flex-col items-center justify-center gap-1 transition-colors">
                        <i class="fas fa-eye"></i>
                        <span class="text-xs">Preview</span>
                    </button>
                    <button onclick="downloadAsImage()" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg flex flex-col items-center justify-center gap-1 transition-colors">
                        <i class="fas fa-download"></i>
                        <span class="text-xs">JPG</span>
                    </button>
                    <button onclick="downloadAsPDF()" class="bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg flex flex-col items-center justify-center gap-1 transition-colors">
                        <i class="fas fa-file-pdf"></i>
                        <span class="text-xs">PDF</span>
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex mb-4 border-b border-gray-700">
                <button class="tab-button active" onclick="showTab('content')">Content</button>
                <button class="tab-button" onclick="showTab('style')">Style</button>
                <button class="tab-button" onclick="showTab('structure')">Structure</button>
                <button class="tab-button" onclick="showTab('advanced')">Advanced</button>
            </div>
            
            <!-- Content Tab -->
            <div id="content-tab" class="tab-content">
                <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Quick Edits -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3 flex items-center gap-2">
                            <i class="fas fa-bolt"></i> Quick Edits
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Document Title</label>
                                <input type="text" id="quick-title" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="LETTER OF INTENT">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Reference Number</label>
                                <input type="text" id="quick-ref" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="OGI-LOI-12/2023">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Date</label>
                                <input type="text" id="quick-date" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="December 05, 2023">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Company Details -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Company Details</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Company Name Line 1</label>
                                <input type="text" id="company-line1" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="OPULENCE GROUP">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Company Name Line 2</label>
                                <input type="text" id="company-line2" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="INDONESIA">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Tagline</label>
                                <input type="text" id="company-tagline" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Global Trade & Investment Solutions">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Phone Number</label>
                                <input type="text" id="company-phone" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="+62 831-8271-8126">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Email</label>
                                <input type="text" id="company-email" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="purchasedaf@yahoo.com">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Header Address</label>
                                <input type="text" id="header-address" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Tower Anugrah Floor 16 Office Garden E.3.8, Mega Kuningan Area">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Footer Address</label>
                                <input type="text" id="footer-address" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Tower Anugrah Floor 16 Office Garden E.3.8, Mega Kuningan Area, Dr. Ide Anak Street Agung Gde">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Copyright Text</label>
                                <input type="text" id="copyright-text" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Â© 2023 Opulence Group Indonesia. All Rights Reserved.">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Footer Company Name</label>
                                <input type="text" id="footer-company" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="OPULENCE GROUP INDONESIA">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Footer Tagline</label>
                                <input type="text" id="footer-tagline" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Global Trade & Investment Solutions">
                            </div>
                        </div>
                    </div>
                    
                    <!-- From/To Details -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Address Details</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">From Company</label>
                                <input type="text" id="from-company" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Opulence Group Indonesia">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">To Company</label>
                                <input type="text" id="to-company" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Silver Line Compass LLP">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">From Address Line 1</label>
                                <input type="text" id="from-address1" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Tower Anugrah Floor 16 Office Garden E.3.8">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">From Address Line 2</label>
                                <input type="text" id="from-address2" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Mega Kuningan Area, Dr. Ide Anak Street">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">From Address Line 3</label>
                                <input type="text" id="from-address3" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Agung Gde, Jakarta, Indonesia">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Details -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Product Details</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Product Name</label>
                                <input type="text" id="product-name" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Premium Grade Cardamom">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">HSN/SAC Code</label>
                                <input type="text" id="product-hsn" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="0910.11.00">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-sm text-gray-300">Quantity</label>
                                    <input type="text" id="product-quantity" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="12">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-300">Unit</label>
                                    <select id="product-unit" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="Metric Tons">Metric Tons</option>
                                        <option value="Kg">Kg</option>
                                        <option value="Units">Units</option>
                                        <option value="Pieces">Pieces</option>
                                        <option value="Boxes">Boxes</option>
                                        <option value="Litres">Litres</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Price per Unit (USD)</label>
                                <input type="text" id="product-price" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="32,083.33">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Amount (USD)</label>
                                <input type="text" id="product-amount" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="385,000.00" readonly>
                            </div>
                        </div>
                        
                        <!-- Add More Products Button -->
                        <div class="mt-4">
                            <button onclick="openAddProductModal()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-plus mr-2"></i> Add More Products
                            </button>
                        </div>
                        
                        <!-- Current Products List -->
                        <div class="mt-4">
                            <h5 class="text-sm font-bold text-blue-300 mb-2">Current Products:</h5>
                            <div id="products-list" class="space-y-2">
                                <!-- Products will be listed here dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Signature Details -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Signature Details</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Signatory Name</label>
                                <input type="text" id="signatory-name" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="DAMAI KHAMUIR">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Designation</label>
                                <input type="text" id="signatory-designation" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Purchasing Manager">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button onclick="applyQuickEdits()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors">
                        <i class="fas fa-check"></i>
                        Apply All Quick Edits
                    </button>
                </div>
            </div>
            
            <!-- Style Tab -->
            <div id="style-tab" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Colors</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm text-gray-300">Primary Color</label>
                                <input type="color" id="color-primary" class="w-full h-10 cursor-pointer rounded border border-gray-600" value="#1e3a8a">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Secondary Color</label>
                                <input type="color" id="color-secondary" class="w-full h-10 cursor-pointer rounded border border-gray-600" value="#3b82f6">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Fonts</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Heading Font</label>
                                <select id="font-heading" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="'Playfair Display', serif">Playfair Display</option>
                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Arial', sans-serif">Arial</option>
                                    <option value="'Georgia', serif">Georgia</option>
                                    <option value="'Times New Roman', serif">Times New Roman</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Body Font</label>
                                <select id="font-body" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                    <option value="'Playfair Display', serif">Playfair Display</option>
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Arial', sans-serif">Arial</option>
                                    <option value="'Open Sans', sans-serif">Open Sans</option>
                                    <option value="'Helvetica', sans-serif">Helvetica</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Watermark</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Watermark Text</label>
                                <input type="text" id="watermark-text" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" value="LETTER OF INTENT">
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Watermark Opacity</label>
                                <input type="range" id="watermark-opacity" min="0" max="10" value="3" class="w-full">
                                <span id="opacity-value" class="text-xs text-gray-300">30%</span>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="applyStyles()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        Apply Styles
                    </button>
                </div>
            </div>
            
            <!-- Structure Tab -->
            <div id="structure-tab" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Sections</h4>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-header" checked class="mr-2">
                                <label for="section-header" class="text-gray-300">Header</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-address" checked class="mr-2">
                                <label for="section-address" class="text-gray-300">From/To Address</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-title" checked class="mr-2">
                                <label for="section-title" class="text-gray-300">Letter Title</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-content" checked class="mr-2">
                                <label for="section-content" class="text-gray-300">Main Content</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-table" checked class="mr-2">
                                <label for="section-table" class="text-gray-300">Product Table</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-signature" checked class="mr-2">
                                <label for="section-signature" class="text-gray-300">Signature</label>
                            </div>
                            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                                <i class="fas fa-bars drag-handle"></i>
                                <input type="checkbox" id="section-footer" checked class="mr-2">
                                <label for="section-footer" class="text-gray-300">Footer</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Reorder Sections</h4>
                        <p class="text-sm text-gray-400 mb-3">Drag and drop to reorder:</p>
                        <div id="sortable-sections" class="space-y-2">
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Header
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Address Section
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Letter Title
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Main Content
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Product Table
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Signature
                            </div>
                            <div class="p-3 bg-gray-700 rounded cursor-move border border-gray-600">
                                <i class="fas fa-grip-lines mr-2"></i> Footer
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="applyStructure()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        Apply Structure Changes
                    </button>
                </div>
            </div>
            
            <!-- Advanced Tab -->
            <div id="advanced-tab" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Table Editor</h4>
                        <div class="space-y-3">
                            <button onclick="addTableRow()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i> Add Table Row
                            </button>
                            <button onclick="removeTableRow()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-minus mr-2"></i> Remove Last Row
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Export/Import</h4>
                        <div class="space-y-3">
                            <button onclick="exportData()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-file-export mr-2"></i> Export Data
                            </button>
                            <button onclick="importData()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-file-import mr-2"></i> Import Data
                            </button>
                            <input type="file" id="import-file" class="hidden" accept=".json">
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-300 mb-3">Reset Options</h4>
                        <div class="space-y-2">
                            <button onclick="resetToDefault()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-undo mr-2"></i> Reset All Content
                            </button>
                            <button onclick="clearAll()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-trash mr-2"></i> Clear Everything
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status -->
            <div class="mt-6 p-4 bg-gray-800/50 rounded-lg">
                <h4 class="font-bold text-blue-300 mb-2">Status</h4>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-300">Last Saved:</span>
                        <span id="last-saved" class="text-white">Not saved yet</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Word Count:</span>
                        <span id="word-count" class="text-white">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Editing Mode:</span>
                        <span id="edit-mode" class="text-green-400">ON</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preview Area -->
    <div class="letter-preview">
        <div id="letter-container" class="letter-container p-8 md:p-12">
            <!-- This entire area is editable -->
            <!-- We'll build it dynamically -->
        </div>
        
        <!-- Edit Popup -->
        <div id="edit-popup" class="edit-popup hidden">
            <div class="mb-3">
                <h4 class="font-bold text-gray-800" id="edit-title">Edit Content</h4>
                <p class="text-sm text-gray-600" id="edit-label"></p>
            </div>
            <textarea id="edit-textarea" placeholder="Enter content here..."></textarea>
            <div class="flex gap-2 mt-3">
                <button onclick="saveEdit()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex-1 transition-colors">
                    Save Changes
                </button>
                <button onclick="cancelEdit()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition-colors">
                    Cancel
                </button>
            </div>
        </div>
        
        <!-- Font Editor -->
        <div id="font-editor" class="font-editor hidden">
            <h4 class="font-bold text-gray-800 mb-3">Font Settings</h4>
            <div class="space-y-3">
                <div>
                    <label class="text-sm text-gray-700 mb-1 block">Font Family</label>
                    <select id="font-family-select" class="w-full p-2 border rounded">
                        <option value="'Montserrat', sans-serif">Montserrat</option>
                        <option value="'Playfair Display', serif">Playfair Display</option>
                        <option value="'Roboto', sans-serif">Roboto</option>
                        <option value="'Arial', sans-serif">Arial</option>
                        <option value="'Georgia', serif">Georgia</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-700 mb-1 block">Font Size</label>
                    <select id="font-size-select" class="w-full p-2 border rounded">
                        <option value="12px">12px</option>
                        <option value="14px">14px</option>
                        <option value="16px" selected>16px</option>
                        <option value="18px">18px</option>
                        <option value="20px">20px</option>
                        <option value="24px">24px</option>
                        <option value="28px">28px</option>
                        <option value="32px">32px</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-700 mb-1 block">Font Weight</label>
                    <select id="font-weight-select" class="w-full p-2 border rounded">
                        <option value="300">Light (300)</option>
                        <option value="400" selected>Normal (400)</option>
                        <option value="500">Medium (500)</option>
                        <option value="600">Semi Bold (600)</option>
                        <option value="700">Bold (700)</option>
                        <option value="800">Extra Bold (800)</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-700 mb-1 block">Text Color</label>
                    <div class="color-picker-container">
                        <input type="color" id="text-color-picker" value="#000000" class="cursor-pointer">
                        <div id="text-color-preview" class="color-preview" style="background-color: #000000;"></div>
                        <input type="text" id="text-color-hex" value="#000000" class="flex-1 p-2 border rounded text-sm">
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="applyFontSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex-1 transition-colors">
                        Apply
                    </button>
                    <button onclick="closeFontEditor()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Floating Toolbar -->
        <div id="floating-toolbar" class="floating-toolbar hidden">
            <button onclick="formatText('bold')" title="Bold">
                <i class="fas fa-bold"></i>
            </button>
            <button onclick="formatText('italic')" title="Italic">
                <i class="fas fa-italic"></i>
            </button>
            <button onclick="formatText('underline')" title="Underline">
                <i class="fas fa-underline"></i>
            </button>
            <div class="w-px h-6 bg-gray-300"></div>
            <button onclick="openFontEditor()" title="Font Settings">
                <i class="fas fa-font"></i>
            </button>
            <button onclick="alignText('left')" title="Align Left">
                <i class="fas fa-align-left"></i>
            </button>
            <button onclick="alignText('center')" title="Align Center">
                <i class="fas fa-align-center"></i>
            </button>
            <button onclick="alignText('right')" title="Align Right">
                <i class="fas fa-align-right"></i>
            </button>
            <div class="w-px h-6 bg-gray-300"></div>
            <button onclick="closeFloatingToolbar()" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Add Product Modal -->
        <div id="add-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Add New Product</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                            <input type="text" id="new-product-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Premium Cardamom">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">HSN/SAC Code</label>
                            <input type="text" id="new-product-hsn" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 0910.11.00">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                <input type="number" id="new-product-quantity" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 12" step="0.01">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                                <select id="new-product-unit" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Metric Tons">Metric Tons</option>
                                    <option value="Kg">Kg</option>
                                    <option value="Units">Units</option>
                                    <option value="Pieces">Pieces</option>
                                    <option value="Boxes">Boxes</option>
                                    <option value="Litres">Litres</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price per Unit (USD)</label>
                            <input type="number" id="new-product-price" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 32083.33" step="0.01">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Amount (USD)</label>
                            <input type="text" id="new-product-amount" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="Auto-calculated" readonly>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveNewProduct()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i> Add Product
                        </button>
                        <button onclick="closeAddProductModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentEditingElement = null;
        let changesMade = 0;
        let isEditingMode = true;
        let letterData = {};
        let selectedTextElement = null;
        
        // Default data structure
        const defaultData = {
            header: {
                companyLine1: "OPULENCE GROUP",
                companyLine2: "INDONESIA",
                tagline: "Global Trade & Investment Solutions",
                phone: "+62 831-8271-8126",
                email: "purchasedaf@yahoo.com",
                documentType: "Letter of Intent",
                date: "December 05, 2023",
                reference: "Ref: OGI-LOI-12/2023",
                logoUrl: "https://araldomqfedor-blip.github.io/loi/loko.png",
                headerAddress: "Tower Anugrah Floor 16 Office Garden E.3.8, Mega Kuningan Area"
            },
            addresses: {
                fromCompany: "Opulence Group Indonesia",
                fromAddress1: "Tower Anugrah Floor 16 Office Garden E.3.8",
                fromAddress2: "Mega Kuningan Area, Dr. Ide Anak Street",
                fromAddress3: "Agung Gde, Jakarta, Indonesia",
                toCompany: "Silver Line Compass LLP",
                toAddress1: "H.NO-1804/5 Barchi Road Dandeli",
                toAddress2: "Uttara Kannada Karnataka",
                toAddress3: "581325, India"
            },
            content: {
                title: "LETTER OF INTENT",
                salutation: "Dear Sir/Madam,",
                paragraph1: "We take this opportunity to formally declare our intention to procure agricultural products from your esteemed company. <strong>Opulence Group Indonesia</strong> is a duly registered entity operating under the laws of the Republic of Indonesia, with our principal business located at:",
                addressQuote: "Tower Anugrah Floor 16 Office Garden E.3.8, Mega Kuningan Area, Dr. Ide Anak Street Agung Gde, Jakarta, Indonesia",
                paragraph2: "Our core business activities encompass comprehensive Global Trade & Investment Solutions across Southeast Asia.",
                paragraph3: "In accordance with our business expansion strategy, we hereby confirm with full corporate responsibility our willingness and capacity to enter into a formal purchase agreement for the following commodities:",
                products: [
                    {
                        name: "Premium Grade Cardamom",
                        hsn: "0910.11.00",
                        quantity: "12",
                        unit: "Metric Tons",
                        price: "32,083.33",
                        amount: "385,000.00"
                    }
                ],
                tableRows: [],
                subtotal: "385,000.00",
                total: "385,000.00"
            },
            signature: {
                name: "DAMAI KHAMUIR",
                designation: "Purchasing Manager",
                company: "OPULENCE GROUP INDONESIA",
                date: "December 05, 2023"
            },
            footer: {
                address: "Tower Anugrah Floor 16 Office Garden E.3.8, Mega Kuningan Area, Dr. Ide Anak Street Agung Gde",
                copyright: "Â© 2023 Opulence Group Indonesia. All Rights Reserved.",
                phone: "+62 831-8271-8126",
                email: "purchasedaf@yahoo.com",
                companyName: "OPULENCE GROUP INDONESIA",
                tagline: "Global Trade & Investment Solutions"
            },
            styles: {
                primaryColor: "#1e3a8a",
                secondaryColor: "#3b82f6",
                headingFont: "'Playfair Display', serif",
                bodyFont: "'Montserrat', sans-serif"
            }
        };
        
        // Initialize
        function init() {
            // Load data from localStorage or use default
            const savedData = localStorage.getItem('opulenceGroupLetter');
            if (savedData) {
                letterData = JSON.parse(savedData);
                updateTableFromProducts();
            } else {
                letterData = JSON.parse(JSON.stringify(defaultData));
                updateTableFromProducts();
            }
            
            // Initialize form inputs
            initializeFormInputs();
            
            // Update products list
            updateProductsList();
            
            // Render the letter
            renderLetter();
            
            // Initialize sortable
            Sortable.create(document.getElementById('sortable-sections'), {
                animation: 150,
                ghostClass: 'bg-blue-900/20'
            });
            
            // Calculate word count
            calculateWordCount();
            
            // Update status
            updateStatus();
            
            // Set up auto-calculate for product fields
            setupAutoCalculate();
            
            // Setup color picker
            setupColorPicker();
            
            // Setup text selection handling
            setupTextSelection();
        }
        
        // Setup text selection handling
        function setupTextSelection() {
            document.addEventListener('selectionchange', function() {
                const selection = window.getSelection();
                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    const range = selection.getRangeAt(0);
                    const parentElement = range.commonAncestorContainer.parentElement;
                    
                    if (parentElement.classList.contains('editable') || parentElement.classList.contains('table-editable')) {
                        selectedTextElement = parentElement;
                        showFloatingToolbar(range);
                    }
                }
            });
        }
        
        // Show floating toolbar
        function showFloatingToolbar(range) {
            const toolbar = document.getElementById('floating-toolbar');
            const rect = range.getBoundingClientRect();
            
            toolbar.style.top = (rect.top + window.scrollY - 50) + 'px';
            toolbar.style.left = (rect.left + window.scrollX + rect.width/2 - 100) + 'px';
            toolbar.classList.remove('hidden');
        }
        
        // Close floating toolbar
        function closeFloatingToolbar() {
            document.getElementById('floating-toolbar').classList.add('hidden');
            selectedTextElement = null;
        }
        
        // Format text
        function formatText(format) {
            if (!selectedTextElement) return;
            
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                
                if (selectedText) {
                    let formattedText = selectedText;
                    
                    switch(format) {
                        case 'bold':
                            formattedText = `<strong>${selectedText}</strong>`;
                            break;
                        case 'italic':
                            formattedText = `<em>${selectedText}</em>`;
                            break;
                        case 'underline':
                            formattedText = `<u>${selectedText}</u>`;
                            break;
                    }
                    
                    const span = document.createElement('span');
                    span.innerHTML = formattedText;
                    range.deleteContents();
                    range.insertNode(span);
                    
                    // Update data
                    updateElementData(selectedTextElement);
                }
            }
            
            closeFloatingToolbar();
        }
        
        // Align text
        function alignText(alignment) {
            if (!selectedTextElement) return;
            
            selectedTextElement.style.textAlign = alignment;
            updateElementData(selectedTextElement);
            closeFloatingToolbar();
        }
        
        // Open font editor
        function openFontEditor() {
            if (!selectedTextElement) return;
            
            const fontEditor = document.getElementById('font-editor');
            const rect = selectedTextElement.getBoundingClientRect();
            
            // Get current styles
            const computedStyle = window.getComputedStyle(selectedTextElement);
            const currentFont = computedStyle.fontFamily;
            const currentSize = computedStyle.fontSize;
            const currentWeight = computedStyle.fontWeight;
            const currentColor = computedStyle.color;
            
            // Set current values
            document.getElementById('font-family-select').value = currentFont;
            document.getElementById('font-size-select').value = currentSize;
            document.getElementById('font-weight-select').value = currentWeight;
            document.getElementById('text-color-picker').value = rgbToHex(currentColor);
            document.getElementById('text-color-hex').value = rgbToHex(currentColor);
            document.getElementById('text-color-preview').style.backgroundColor = rgbToHex(currentColor);
            
            // Position and show editor
            fontEditor.style.top = (rect.bottom + window.scrollY + 10) + 'px';
            fontEditor.style.left = (rect.left + window.scrollX) + 'px';
            fontEditor.classList.remove('hidden');
            
            closeFloatingToolbar();
        }
        
        // Close font editor
        function closeFontEditor() {
            document.getElementById('font-editor').classList.add('hidden');
        }
        
        // Apply font settings
        function applyFontSettings() {
            if (!selectedTextElement) return;
            
            const fontFamily = document.getElementById('font-family-select').value;
            const fontSize = document.getElementById('font-size-select').value;
            const fontWeight = document.getElementById('font-weight-select').value;
            const textColor = document.getElementById('text-color-picker').value;
            
            selectedTextElement.style.fontFamily = fontFamily;
            selectedTextElement.style.fontSize = fontSize;
            selectedTextElement.style.fontWeight = fontWeight;
            selectedTextElement.style.color = textColor;
            
            updateElementData(selectedTextElement);
            closeFontEditor();
        }
        
        // RGB to Hex converter
        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb;
            
            const result = rgb.match(/\d+/g);
            if (!result) return '#000000';
            
            const r = parseInt(result[0]);
            const g = parseInt(result[1]);
            const b = parseInt(result[2]);
            
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        // Setup color picker
        function setupColorPicker() {
            const picker = document.getElementById('text-color-picker');
            const hex = document.getElementById('text-color-hex');
            const preview = document.getElementById('text-color-preview');
            
            picker.addEventListener('input', function() {
                hex.value = this.value;
                preview.style.backgroundColor = this.value;
            });
            
            hex.addEventListener('input', function() {
                const color = this.value.startsWith('#') ? this.value : '#' + this.value;
                picker.value = color;
                preview.style.backgroundColor = color;
            });
        }
        
        // Update element data
        function updateElementData(element) {
            const editPath = element.getAttribute('data-edit');
            if (!editPath) return;
            
            let target = letterData;
            const keys = editPath.split('.');
            
            for (let i = 0; i < keys.length - 1; i++) {
                if (!target[keys[i]]) target[keys[i]] = {};
                target = target[keys[i]];
            }
            
            // Preserve HTML formatting
            target[keys[keys.length - 1]] = element.innerHTML;
            
            changesMade++;
            updateStatus();
        }
        
        // Set up auto-calculation for product fields
        function setupAutoCalculate() {
            const quantityInput = document.getElementById('product-quantity');
            const priceInput = document.getElementById('product-price');
            const amountInput = document.getElementById('product-amount');
            
            const calculateAmount = () => {
                const quantity = parseFloat(quantityInput.value.replace(/,/g, '')) || 0;
                const price = parseFloat(priceInput.value.replace(/,/g, '')) || 0;
                const amount = quantity * price;
                amountInput.value = amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            };
            
            quantityInput.addEventListener('input', calculateAmount);
            priceInput.addEventListener('input', calculateAmount);
        }
        
        // Initialize form inputs with current data
        function initializeFormInputs() {
            // Quick Edits
            document.getElementById('quick-title').value = letterData.content.title;
            document.getElementById('quick-ref').value = letterData.header.reference.replace("Ref: ", "");
            document.getElementById('quick-date').value = letterData.header.date;
            
            // Company Details
            document.getElementById('company-line1').value = letterData.header.companyLine1;
            document.getElementById('company-line2').value = letterData.header.companyLine2;
            document.getElementById('company-tagline').value = letterData.header.tagline;
            document.getElementById('company-phone').value = letterData.header.phone;
            document.getElementById('company-email').value = letterData.header.email;
            document.getElementById('header-address').value = letterData.header.headerAddress;
            document.getElementById('footer-address').value = letterData.footer.address;
            document.getElementById('copyright-text').value = letterData.footer.copyright;
            document.getElementById('footer-company').value = letterData.footer.companyName;
            document.getElementById('footer-tagline').value = letterData.footer.tagline;
            
            // Address Details
            document.getElementById('from-company').value = letterData.addresses.fromCompany;
            document.getElementById('to-company').value = letterData.addresses.toCompany;
            document.getElementById('from-address1').value = letterData.addresses.fromAddress1;
            document.getElementById('from-address2').value = letterData.addresses.fromAddress2;
            document.getElementById('from-address3').value = letterData.addresses.fromAddress3;
            
            // Product Details
            const firstProduct = letterData.content.products[0] || { name: "", hsn: "", quantity: "", unit: "Metric Tons", price: "", amount: "" };
            document.getElementById('product-name').value = firstProduct.name;
            document.getElementById('product-hsn').value = firstProduct.hsn;
            document.getElementById('product-quantity').value = firstProduct.quantity;
            document.getElementById('product-unit').value = firstProduct.unit || "Metric Tons";
            document.getElementById('product-price').value = firstProduct.price;
            document.getElementById('product-amount').value = firstProduct.amount;
            
            // Signature Details
            document.getElementById('signatory-name').value = letterData.signature.name;
            document.getElementById('signatory-designation').value = letterData.signature.designation;
            
            // Style inputs
            document.getElementById('color-primary').value = letterData.styles.primaryColor;
            document.getElementById('color-secondary').value = letterData.styles.secondaryColor;
            document.getElementById('font-heading').value = letterData.styles.headingFont;
            document.getElementById('font-body').value = letterData.styles.bodyFont;
        }
        
        // Update products list in sidebar
        function updateProductsList() {
            const productsList = document.getElementById('products-list');
            productsList.innerHTML = '';
            
            if (letterData.content.products && letterData.content.products.length > 0) {
                letterData.content.products.forEach((product, index) => {
                    const productElement = document.createElement('div');
                    productElement.className = 'product-item';
                    productElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-white">${product.name}</div>
                                <div class="text-sm text-gray-300">
                                    ${product.quantity} ${product.unit} Ã ${product.price} = ${product.amount} USD
                                </div>
                                <div class="text-xs text-gray-400 mt-1">HSN: ${product.hsn}</div>
                            </div>
                            <button onclick="removeProduct(${index})" class="ml-2 text-red-400 hover:text-red-300">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    productsList.appendChild(productElement);
                });
            } else {
                productsList.innerHTML = '<p class="text-gray-400 text-sm">No products added yet.</p>';
            }
        }
        
        // Update table from products
        function updateTableFromProducts() {
            // Clear existing table rows
            letterData.content.tableRows = [];
            
            let subtotal = 0;
            
            if (letterData.content.products && letterData.content.products.length > 0) {
                // Add header row
                letterData.content.tableRows.push([
                    "Item Name",
                    "HSN/SAC",
                    "Quantity",
                    "Unit",
                    "Price/Unit (USD)",
                    "Amount (USD)"
                ]);
                
                // Add each product row
                letterData.content.products.forEach((product, index) => {
                    const amount = parseFloat(product.amount.replace(/[^0-9.]/g, '')) || 0;
                    subtotal += amount;
                    
                    letterData.content.tableRows.push([
                        product.name,
                        product.hsn,
                        product.quantity,
                        product.unit,
                        product.price,
                        product.amount
                    ]);
                });
                
                // Add subtotal and total rows
                letterData.content.subtotal = subtotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                letterData.content.total = subtotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
        }
        
        // Render the letter
        function renderLetter() {
            const container = document.getElementById('letter-container');
            container.innerHTML = '';
            
            // Create sections array
            const sections = [
                { id: 'header', render: renderHeader },
                { id: 'addresses', render: renderAddresses },
                { id: 'title', render: renderTitle },
                { id: 'content', render: renderContent },
                { id: 'table', render: renderTable },
                { id: 'signature', render: renderSignature },
                { id: 'footer', render: renderFooter }
            ];
            
            // Render each section
            sections.forEach(section => {
                const sectionElement = section.render();
                if (sectionElement) {
                    container.appendChild(sectionElement);
                }
            });
            
            // Apply styles
            applyStylesToLetter();
            
            // Make elements editable
            makeElementsEditable();
            
            // Calculate word count
            calculateWordCount();
        }
        
        // Render header section
        function renderHeader() {
            const section = document.createElement('div');
            section.className = 'mb-12';
            section.innerHTML = `
                <div class="bg-gradient-to-r from-blue-900 to-blue-700 text-white rounded-xl shadow-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="flex items-center gap-4 mb-6 md:mb-0">
                            <div class="bg-white w-20 h-20 flex items-center justify-center shadow-lg rounded-xl overflow-hidden">
                                <img src="${letterData.header.logoUrl}" alt="Opulence Group Indonesia Logo" class="w-full h-full object-contain p-2">
                            </div>
                            <div>
                                <h1 class="text-3xl md:text-4xl font-bold" data-edit="header.companyLine1">${letterData.header.companyLine1}</h1>
                                <h2 class="text-3xl md:text-4xl font-bold" data-edit="header.companyLine2">${letterData.header.companyLine2}</h2>
                                <p class="text-blue-200 text-sm mt-1" data-edit="header.tagline">${letterData.header.tagline}</p>
                            </div>
                        </div>
                        
                        <div class="text-center md:text-right">
                            <div class="mb-2">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                <span data-edit="header.headerAddress">${letterData.header.headerAddress}</span>
                            </div>
                            <div class="mb-2">
                                <i class="fas fa-phone mr-2"></i>
                                <span data-edit="header.phone">${letterData.header.phone}</span>
                            </div>
                            <div>
                                <i class="fas fa-envelope mr-2"></i>
                                <span class="text-blue-200" data-edit="header.email">${letterData.header.email}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-blue-400">
                        <div class="flex flex-wrap justify-between items-center">
                            <div>
                                <p class="text-blue-200"><i class="fas fa-file-contract mr-2"></i> <span data-edit="header.documentType">${letterData.header.documentType}</span></p>
                            </div>
                            <div class="flex gap-4">
                                <p class="text-blue-200"><i class="far fa-calendar mr-2"></i> <span data-edit="header.date">${letterData.header.date}</span></p>
                                <p class="text-blue-200"><i class="fas fa-hashtag mr-2"></i> <span data-edit="header.reference">${letterData.header.reference}</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return section;
        }
        
        // Render addresses section
        function renderAddresses() {
            const section = document.createElement('div');
            section.className = 'grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12';
            section.innerHTML = `
                <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-blue-100 p-2 rounded-full">
                            <i class="fas fa-building text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">From: <span data-edit="addresses.fromCompany">${letterData.addresses.fromCompany}</span></h3>
                    </div>
                    <div class="space-y-2 text-gray-700">
                        <p><strong>Address:</strong></p>
                        <p data-edit="addresses.fromAddress1">${letterData.addresses.fromAddress1}</p>
                        <p data-edit="addresses.fromAddress2">${letterData.addresses.fromAddress2}</p>
                        <p data-edit="addresses.fromAddress3">${letterData.addresses.fromAddress3}</p>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-blue-100 p-2 rounded-full">
                            <i class="fas fa-users text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">To: <span data-edit="addresses.toCompany">${letterData.addresses.toCompany}</span></h3>
                    </div>
                    <div class="space-y-2 text-gray-700">
                        <p><strong>Address:</strong></p>
                        <p data-edit="addresses.toAddress1">${letterData.addresses.toAddress1}</p>
                        <p data-edit="addresses.toAddress2">${letterData.addresses.toAddress2}</p>
                        <p data-edit="addresses.toAddress3">${letterData.addresses.toAddress3}</p>
                    </div>
                </div>
            `;
            return section;
        }
        
        // Render title section
        function renderTitle() {
            const section = document.createElement('div');
            section.className = 'text-center mb-12';
            section.innerHTML = `
                <h1 class="text-4xl md:text-5xl font-bold mb-4" data-edit="content.title" style="font-family: ${letterData.styles.headingFont}; color: ${letterData.styles.primaryColor}">${letterData.content.title}</h1>
                <div class="h-1 w-32 bg-blue-600 mx-auto rounded-full"></div>
            `;
            return section;
        }
        
        // Render main content
        function renderContent() {
            const section = document.createElement('div');
            section.className = 'space-y-6 text-gray-800 text-justify mb-8';
            section.innerHTML = `
                <p>
                    <span class="font-semibold text-lg" data-edit="content.salutation">${letterData.content.salutation}</span>
                </p>

                <p data-edit="content.paragraph1">${letterData.content.paragraph1}</p>

                <div class="bg-blue-50 p-5 rounded-lg my-6 border-l-4 border-blue-500">
                    <p class="font-medium text-blue-800 italic" data-edit="content.addressQuote">
                        "${letterData.content.addressQuote}"
                    </p>
                </div>

                <p data-edit="content.paragraph2">${letterData.content.paragraph2}</p>

                <p class="font-medium" style="color: ${letterData.styles.primaryColor}" data-edit="content.paragraph3">
                    ${letterData.content.paragraph3}
                </p>
            `;
            return section;
        }
        
        // Render table - FIXED VERSION
        function renderTable() {
            const section = document.createElement('div');
            section.className = 'overflow-x-auto my-8';
            
            let tableRowsHTML = '';
            
            // Add header row
            tableRowsHTML += `
                <tr class="bg-gradient-to-r from-blue-50 to-blue-100">
                    <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-800 text-sm">Item Name</th>
                    <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-800 text-sm">HSN/SAC</th>
                    <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-800 text-sm">Quantity</th>
                    <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-800 text-sm">Unit</th>
                    <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-800 text-sm">Price/Unit (USD)</th>
                    <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-800 text-sm">Amount (USD)</th>
                </tr>
            `;
            
            // Add product rows - FIXED: Added table-editable class and proper event listeners
            letterData.content.products.forEach((product, index) => {
                tableRowsHTML += `
                    <tr class="hover:bg-gray-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                        <td class="border border-gray-300 px-4 py-3 table-editable" 
                            data-edit="content.products.${index}.name" 
                            data-index="${index}" 
                            data-field="name">${product.name}</td>
                        <td class="border border-gray-300 px-4 py-3 table-editable" 
                            data-edit="content.products.${index}.hsn" 
                            data-index="${index}" 
                            data-field="hsn">${product.hsn}</td>
                        <td class="border border-gray-300 px-4 py-3 text-right table-editable" 
                            data-edit="content.products.${index}.quantity" 
                            data-index="${index}" 
                            data-field="quantity">${product.quantity}</td>
                        <td class="border border-gray-300 px-4 py-3 table-editable" 
                            data-edit="content.products.${index}.unit" 
                            data-index="${index}" 
                            data-field="unit">${product.unit}</td>
                        <td class="border border-gray-300 px-4 py-3 text-right table-editable" 
                            data-edit="content.products.${index}.price" 
                            data-index="${index}" 
                            data-field="price">${product.price}</td>
                        <td class="border border-gray-300 px-4 py-3 text-right font-medium table-editable" 
                            data-edit="content.products.${index}.amount" 
                            data-index="${index}" 
                            data-field="amount">${product.amount}</td>
                    </tr>
                `;
            });
            
            // Add empty row for spacing
            tableRowsHTML += `
                <tr>
                    <td colspan="6" class="py-2"></td>
                </tr>
            `;
            
            // Add subtotal and total rows - FIXED: Added table-editable class
            tableRowsHTML += `
                <tr class="border-t-2 border-gray-300">
                    <td colspan="4" class="px-4 py-3"></td>
                    <td class="border border-gray-300 px-4 py-3 bg-gray-100 font-bold text-right">Sub Total</td>
                    <td class="border border-gray-300 px-4 py-3 bg-gray-100 font-bold text-right table-editable" 
                        data-edit="content.subtotal">${letterData.content.subtotal}</td>
                </tr>
                <tr>
                    <td colspan="4" class="px-4 py-3"></td>
                    <td class="border border-gray-300 px-4 py-3 bg-blue-100 font-bold text-right text-blue-800">Total</td>
                    <td class="border border-gray-300 px-4 py-3 bg-blue-100 font-bold text-right text-blue-800 table-editable" 
                        data-edit="content.total">${letterData.content.total}</td>
                </tr>
            `;
            
            section.innerHTML = `
                <table class="w-full border-collapse border border-gray-300 shadow-sm text-sm">
                    <thead>
                        ${tableRowsHTML}
                    </thead>
                </table>
            `;
            return section;
        }
        
        // Render signature
        function renderSignature() {
            const section = document.createElement('div');
            section.className = 'mt-16 pt-8 border-t border-gray-300';
            section.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-start">
                    <div class="mb-8 md:mb-0">
                        <p class="text-lg font-medium text-gray-700 mb-6">Sincerely,</p>
                        
                        <div class="space-y-1">
                            <p class="text-2xl font-bold text-gray-900" data-edit="signature.name">${letterData.signature.name}</p>
                            <p class="text-gray-600" data-edit="signature.designation">${letterData.signature.designation}</p>
                            <p class="text-blue-700 font-medium" data-edit="signature.company">${letterData.signature.company}</p>
                        </div>
                        
                        <div class="border-b-2 border-gray-800 w-64 mt-8"></div>
                        <p class="text-sm text-gray-500 mt-2">Authorized Signature</p>
                    </div>
                    
                    <div class="text-right">
                        <div class="bg-gray-50 p-5 rounded-lg inline-block">
                            <p class="font-bold text-gray-800 mb-2">Date of Issue:</p>
                            <p class="text-lg text-blue-700" data-edit="signature.date">${letterData.signature.date}</p>
                        </div>
                    </div>
                </div>
            `;
            return section;
        }
        
        // Render footer
        function renderFooter() {
            const section = document.createElement('footer');
            section.className = 'bg-gray-900 text-white py-8 mt-12 rounded-xl';
            section.innerHTML = `
                <div class="max-w-6xl mx-auto px-4">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="mb-6 md:mb-0">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-white p-2 rounded-lg overflow-hidden">
                                    <img src="${letterData.header.logoUrl}" alt="Opulence Group Indonesia Logo" class="w-12 h-12 object-contain">
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold" data-edit="footer.companyName">${letterData.footer.companyName}</h3>
                                    <p class="text-gray-400 text-sm" data-edit="footer.tagline">${letterData.footer.tagline}</p>
                                </div>
                            </div>
                            <p class="text-gray-400 text-sm">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                <span data-edit="footer.address">${letterData.footer.address}</span>
                            </p>
                        </div>
                        
                        <div class="text-center md:text-right">
                            <div class="mb-4">
                                <span class="text-blue-300">
                                    <i class="fas fa-phone mr-2"></i>
                                    <span data-edit="footer.phone">${letterData.footer.phone}</span>
                                </span>
                            </div>
                            <p class="text-gray-400 text-sm" data-edit="footer.copyright">
                                ${letterData.footer.copyright}
                            </p>
                        </div>
                    </div>
                </div>
            `;
            return section;
        }
        
        // Apply styles to letter
        function applyStylesToLetter() {
            const container = document.getElementById('letter-container');
            
            // Update heading font
            const headings = container.querySelectorAll('[class*="text-4xl"], [class*="text-5xl"], [class*="text-3xl"]');
            headings.forEach(h => {
                h.style.fontFamily = letterData.styles.headingFont;
            });
            
            // Update body font
            const bodyElements = container.querySelectorAll('p, span, td');
            bodyElements.forEach(el => {
                if (!el.style.fontFamily) {
                    el.style.fontFamily = letterData.styles.bodyFont;
                }
            });
        }
        
        // Make elements editable - FIXED VERSION
        function makeElementsEditable() {
            // Regular editable elements
            const editableElements = document.querySelectorAll('[data-edit]');
            
            editableElements.forEach(element => {
                // Add editable class
                element.classList.add('editable');
                
                // Remove existing event listeners
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
                
                // Add click event for direct editing
                newElement.addEventListener('click', function(e) {
                    if (!isEditingMode) return;
                    
                    e.stopPropagation();
                    startEditing(this);
                });
            });
            
            // Table editable elements
            const tableEditableElements = document.querySelectorAll('.table-editable');
            
            tableEditableElements.forEach(element => {
                // Add editable class
                element.classList.add('editable');
                
                // Remove existing event listeners
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
                
                // Add click event for direct editing
                newElement.addEventListener('click', function(e) {
                    if (!isEditingMode) return;
                    
                    e.stopPropagation();
                    startEditing(this);
                });
            });
        }
        
        // Start editing an element - FIXED for table cells
        function startEditing(element) {
            if (currentEditingElement) {
                currentEditingElement.classList.remove('editing');
            }
            
            currentEditingElement = element;
            currentEditingElement.classList.add('editing');
            
            const editPath = element.getAttribute('data-edit');
            const popup = document.getElementById('edit-popup');
            const textarea = document.getElementById('edit-textarea');
            const label = document.getElementById('edit-label');
            const title = document.getElementById('edit-title');
            
            // Get current value
            let currentValue = getValueByPath(letterData, editPath);
            
            // Special handling for table cells
            if (editPath.startsWith('content.products')) {
                const index = element.getAttribute('data-index');
                const field = element.getAttribute('data-field');
                const product = letterData.content.products[index];
                currentValue = product ? product[field] : '';
                
                title.textContent = 'Edit Product';
                label.textContent = `Editing: ${field.charAt(0).toUpperCase() + field.slice(1)}`;
            } else if (editPath === 'content.subtotal') {
                title.textContent = 'Edit Sub Total';
                label.textContent = 'Editing: Sub Total Amount';
            } else if (editPath === 'content.total') {
                title.textContent = 'Edit Total';
                label.textContent = 'Editing: Total Amount';
            } else {
                title.textContent = 'Edit Content';
                label.textContent = `Editing: ${editPath}`;
            }
            
            textarea.value = currentValue;
            
            // Position popup
            const rect = element.getBoundingClientRect();
            popup.style.top = `${rect.bottom + window.scrollY + 10}px`;
            popup.style.left = `${rect.left + window.scrollX}px`;
            popup.classList.remove('hidden');
            
            // Focus textarea
            setTimeout(() => {
                textarea.focus();
                textarea.select();
            }, 100);
        }
        
        // Save edit - FIXED for table cells
        function saveEdit() {
            if (!currentEditingElement) return;
            
            const editPath = currentEditingElement.getAttribute('data-edit');
            const newValue = document.getElementById('edit-textarea').value;
            
            // Special handling for table cells
            if (editPath.startsWith('content.products')) {
                const index = currentEditingElement.getAttribute('data-index');
                const field = currentEditingElement.getAttribute('data-field');
                
                if (letterData.content.products[index]) {
                    letterData.content.products[index][field] = newValue;
                    
                    // Recalculate amount if quantity or price changed
                    if (field === 'quantity' || field === 'price') {
                        const product = letterData.content.products[index];
                        const quantity = parseFloat(product.quantity.replace(/[^0-9.]/g, '')) || 0;
                        const price = parseFloat(product.price.replace(/[^0-9.]/g, '')) || 0;
                        product.amount = (quantity * price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        
                        // Update subtotal and total
                        updateTableFromProducts();
                    }
                    
                    // Update products list in sidebar
                    updateProductsList();
                }
            } else {
                // Update data for regular fields
                setValueByPath(letterData, editPath, newValue);
            }
            
            // Update the element
            currentEditingElement.innerHTML = newValue;
            
            // Close popup
            cancelEdit();
            
            // If editing a product field, re-render the entire table
            if (editPath.startsWith('content.products')) {
                // Re-render letter to show updated table
                renderLetter();
            }
            
            // Increment changes
            changesMade++;
            updateStatus();
            
            // Show success notification
            showNotification('Edit saved successfully!', 'success');
        }
        
        // Cancel edit
        function cancelEdit() {
            if (currentEditingElement) {
                currentEditingElement.classList.remove('editing');
                currentEditingElement = null;
            }
            
            document.getElementById('edit-popup').classList.add('hidden');
        }
        
        // Get value by path
        function getValueByPath(obj, path) {
            const keys = path.split('.');
            let result = obj;
            
            for (const key of keys) {
                if (result[key] !== undefined) {
                    result = result[key];
                } else {
                    return '';
                }
            }
            
            return result;
        }
        
        // Set value by path
        function setValueByPath(obj, path, value) {
            const keys = path.split('.');
            let current = obj;
            
            for (let i = 0; i < keys.length - 1; i++) {
                if (!current[keys[i]]) current[keys[i]] = {};
                current = current[keys[i]];
            }
            
            current[keys[keys.length - 1]] = value;
        }
        
        // Apply quick edits
        function applyQuickEdits() {
            // Update data from form inputs
            letterData.content.title = document.getElementById('quick-title').value;
            letterData.header.reference = `Ref: ${document.getElementById('quick-ref').value}`;
            letterData.header.date = document.getElementById('quick-date').value;
            
            letterData.header.companyLine1 = document.getElementById('company-line1').value;
            letterData.header.companyLine2 = document.getElementById('company-line2').value;
            letterData.header.tagline = document.getElementById('company-tagline').value;
            letterData.header.phone = document.getElementById('company-phone').value;
            letterData.header.email = document.getElementById('company-email').value;
            letterData.header.headerAddress = document.getElementById('header-address').value;
            
            letterData.addresses.fromCompany = document.getElementById('from-company').value;
            letterData.addresses.toCompany = document.getElementById('to-company').value;
            letterData.addresses.fromAddress1 = document.getElementById('from-address1').value;
            letterData.addresses.fromAddress2 = document.getElementById('from-address2').value;
            letterData.addresses.fromAddress3 = document.getElementById('from-address3').value;
            
            // Update first product
            if (letterData.content.products && letterData.content.products.length > 0) {
                letterData.content.products[0].name = document.getElementById('product-name').value;
                letterData.content.products[0].hsn = document.getElementById('product-hsn').value;
                letterData.content.products[0].quantity = document.getElementById('product-quantity').value;
                letterData.content.products[0].unit = document.getElementById('product-unit').value;
                letterData.content.products[0].price = document.getElementById('product-price').value;
                
                // Recalculate amount
                const quantity = parseFloat(letterData.content.products[0].quantity.replace(/[^0-9.]/g, '')) || 0;
                const price = parseFloat(letterData.content.products[0].price.replace(/[^0-9.]/g, '')) || 0;
                letterData.content.products[0].amount = (quantity * price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                updateTableFromProducts();
                updateProductsList();
            }
            
            letterData.signature.name = document.getElementById('signatory-name').value;
            letterData.signature.designation = document.getElementById('signatory-designation').value;
            letterData.signature.company = letterData.footer.companyName;
            
            // Update footer data
            letterData.footer.address = document.getElementById('footer-address').value;
            letterData.footer.copyright = document.getElementById('copyright-text').value;
            letterData.footer.phone = letterData.header.phone;
            letterData.footer.email = letterData.header.email;
            letterData.footer.companyName = document.getElementById('footer-company').value;
            letterData.footer.tagline = document.getElementById('footer-tagline').value;
            
            // Re-render letter
            renderLetter();
            
            // Show notification
            showNotification('Quick edits applied successfully!', 'success');
            changesMade++;
            updateStatus();
        }
        
        // Apply styles
        function applyStyles() {
            letterData.styles.primaryColor = document.getElementById('color-primary').value;
            letterData.styles.secondaryColor = document.getElementById('color-secondary').value;
            letterData.styles.headingFont = document.getElementById('font-heading').value;
            letterData.styles.bodyFont = document.getElementById('font-body').value;
            
            applyStylesToLetter();
            
            showNotification('Styles applied successfully!', 'success');
            changesMade++;
            updateStatus();
        }
        
        // Save changes
        function saveChanges() {
            localStorage.setItem('opulenceGroupLetter', JSON.stringify(letterData));
            const now = new Date();
            document.getElementById('last-saved').textContent = 
                `${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            showNotification('Changes saved successfully!', 'success');
            changesMade = 0;
            updateStatus();
        }
        
        // Update preview
        function updatePreview() {
            renderLetter();
            showNotification('Preview updated!', 'info');
        }
        
        // Download as image
        function downloadAsImage() {
            const element = document.getElementById('letter-container');
            
            showNotification('Generating image...', 'info');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                backgroundColor: "#ffffff",
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `opulence-group-letter-${new Date().toISOString().slice(0,10)}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                
                showNotification('Image downloaded successfully!', 'success');
            });
        }
        
        // Download as PDF
        function downloadAsPDF() {
            showNotification('PDF download would require additional libraries like jsPDF', 'info');
        }
        
        // Calculate word count
        function calculateWordCount() {
            const text = document.getElementById('letter-container').innerText;
            const words = text.trim().split(/\s+/).filter(word => word.length > 0);
            document.getElementById('word-count').textContent = words.length;
        }
        
        // Update status
        function updateStatus() {
            document.getElementById('last-saved').textContent = 
                localStorage.getItem('opulenceGroupLetter') ? 'Saved' : 'Not saved yet';
        }
        
        // Show tab
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show selected tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        }
        
        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.admin-sidebar');
            sidebar.classList.toggle('open');
        }
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                type === 'warning' ? 'bg-yellow-600' : 
                'bg-blue-600'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 
                        'fa-info-circle'
                    }"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Close edit popup when clicking outside
        document.addEventListener('click', function(e) {
            const popup = document.getElementById('edit-popup');
            const fontEditor = document.getElementById('font-editor');
            
            if (popup && !popup.contains(e.target) && currentEditingElement !== e.target) {
                cancelEdit();
            }
            
            if (fontEditor && !fontEditor.contains(e.target)) {
                closeFontEditor();
            }
            
            const modal = document.getElementById('add-product-modal');
            if (modal && !modal.contains(e.target) && !e.target.closest('[onclick*="openAddProductModal"]')) {
                closeAddProductModal();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveChanges();
            }
            
            // Escape to cancel edit
            if (e.key === 'Escape') {
                cancelEdit();
                closeFontEditor();
                closeFloatingToolbar();
                closeAddProductModal();
            }
        });
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
